name: ğŸ¦ Central Bank Harvest

on:
  workflow_run:
    # å¿…é¡»åŒ¹é…ä¸»ä»»åŠ¡ name
    workflows: ["âš”ï¸ PolyData Dual-Engine System"] 
    types:
      - completed
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘æµ‹è¯•

jobs:
  harvest:
    # åªæœ‰æ‰‹åŠ¨è§¦å‘æˆ–ä¸Šæ¸¸æ‰§è¡ŒæˆåŠŸæ‰è¿è¡Œ
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: â³ 2-Minute Buffer
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "Waiting 2 minutes for settlement..."
            sleep 120
          else
            echo "Manual trigger, skipping wait."
          fi

      - name: Checkout Scraper Repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.MY_PAT }}
          fetch-depth: 0

      - name: Checkout Central Bank
        uses: actions/checkout@v4
        with:
          repository: wenfp108/Central-Bank
          token: ${{ secrets.MY_PAT }}
          path: central_bank

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ¦ Execute Harvest & Wipe
        run: node scripts/archive-poly-to-bank.js

      - name: ğŸ“¤ Push to Central Bank
        run: |
          cd central_bank
          git config --global user.name 'Architect Bot'
          git config --global user.email 'bot@architect.alpha'
          git add .
          git commit -m "Vault Update: archive polymarket data $(date +%F)" || exit 0
          git push

      - name: ğŸ§¹ Sync Deletions to Scraper Repo
        run: |
          git config --global user.name 'Architect Bot'
          git config --global user.email 'bot@architect.alpha'
          git add data/
          git commit -m "Cleanup: Data flushed to Central Bank $(date +%F)" || exit 0
          git push
