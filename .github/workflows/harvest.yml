name: ğŸ¦ Central Bank Harvest

on:
  workflow_run:
    workflows: ["âš”ï¸ PolyData Dual-Engine System"]
    types:
      - completed

jobs:
  harvest_and_cleanup:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Scraper Repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.MY_PAT }} # ä½¿ç”¨ä½ çš„ PAT ä»¥ä¾¿èƒ½æ¨é€å›å½“å‰ä»“åº“

      - name: Checkout Central Bank
        uses: actions/checkout@v4
        with:
          repository: wenfp108/Central-Bank
          token: ${{ secrets.MY_PAT }}
          path: central_bank

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ¦ Execute Harvest
        run: node scripts/archive-poly-to-bank.js

      - name: ğŸ“¤ Push to Central Bank
        run: |
          cd central_bank
          git config --global user.name 'Architect Bot'
          git config --global user.email 'bot@architect.alpha'
          git add .
          git commit -m "Vault Update: archive polymarket data $(date +%F)" || exit 0
          git push

      - name: ğŸ§¹ Sync Deletions to Scraper Repo
        run: |
          # å°†åˆ é™¤æ“ä½œå’Œ .gitkeep æ–‡ä»¶çš„çŠ¶æ€æ¨å›å½“å‰ä»“åº“
          git config --global user.name 'Architect Bot'
          git config --global user.email 'bot@architect.alpha'
          git add data/
          git commit -m "Cleanup: Data moved to Central Bank and local wiped $(date +%F)" || exit 0
          git push
