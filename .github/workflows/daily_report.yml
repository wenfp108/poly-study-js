name: Daily Heatmap & JSON Report

# æ¯å¤©åŒ—äº¬æ—¶é—´ 23:55 è‡ªåŠ¨è¿è¡Œ
on:
  schedule:
    - cron: '55 15 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Generate Reports
        run: |
          cat <<'EOF' > analyzer.py
          import os
          import json
          from datetime import datetime
          
          # === 1. æ™ºèƒ½æŸ¥æ‰¾æœ€æ–°æ•°æ® ===
          data_root = "data"
          if not os.path.exists(data_root):
              print("æ— æ•°æ®ç›®å½•"); exit(0)
          
          all_dirs = [d for d in os.listdir(data_root) if d[0].isdigit()]
          all_dirs.sort()
          if not all_dirs: print("æ— æ•°æ®"); exit(0)
              
          latest_date = all_dirs[-1] 
          source_dir = os.path.join(data_root, latest_date)
          
          # === 2. è¾“å‡ºç›®å½• ===
          report_dir = "reports"
          if not os.path.exists(report_dir): os.makedirs(report_dir)
          print(f"ğŸ¯ åˆ†ææº: {source_dir}")

          # === 3. è¾…åŠ©å‡½æ•° ===
          def get_top_candidate(market_data):
              try:
                  if 'markets' not in market_data or len(market_data['markets']) == 0: return None
                  m = market_data['markets'][0]
                  outcomes = m.get('outcomes')
                  if isinstance(outcomes, str): outcomes = json.loads(outcomes)
                  prices = m.get('outcomePrices')
                  if isinstance(prices, str): prices = json.loads(prices)
                  if not outcomes or not prices: return None
                  candidates = []
                  for i in range(len(outcomes)):
                      try: candidates.append((str(outcomes[i]), float(prices[i])))
                      except: continue
                  candidates.sort(key=lambda x: x[1], reverse=True)
                  return candidates[0]
              except: return None

          # â˜…â˜…â˜… æ ¸å¿ƒå‡çº§ï¼šæ™ºèƒ½å»é‡æ—¶é—´è½´ç”Ÿæˆå™¨ â˜…â˜…â˜…
          def generate_smart_timeline(history_list):
              # 1. å…ˆæŒ‰æ—¶é—´æ’åº
              history_list.sort(key=lambda x: x[0])
              if not history_list: return "æ— æ•°æ®", []
              
              key_frames = []      # å­˜å…³é”®å¸§æ•°æ®
              last_state_str = ""  # ç”¨æ¥å¯¹æ¯”ä¸Šä¸€æ¬¡çš„çŠ¶æ€
              last_winner = ""     # ç”¨æ¥æ£€æµ‹åè½¬

              for ts, content in history_list:
                  data = content.get('data', {})
                  top = get_top_candidate(data)
                  
                  if top:
                      name, prob = top
                      # çŠ¶æ€æŒ‡çº¹ï¼šåå­— + æ•´æ•°èƒœç‡ (ä¾‹å¦‚ "Trump|55")
                      # åªæœ‰è¿™ä¸ªæŒ‡çº¹å˜äº†ï¼Œæˆ‘ä»¬æ‰è®¤ä¸ºè¡Œæƒ…åŠ¨äº†
                      current_state_str = f"{name}|{int(prob*100)}"
                      
                      if current_state_str != last_state_str:
                          # --- æå–æ—¶é—´ (HH:MM) ---
                          try: time_label = ts.split('T')[1][:5]
                          except: time_label = ""
                          
                          # --- è®°å½•å…³é”®å¸§ ---
                          key_frames.append({
                              "time": time_label,
                              "name": name,
                              "prob": prob,
                              "is_flip": (last_winner != "" and name != last_winner) # æ˜¯å¦å‘ç”Ÿåè½¬
                          })
                          
                          # æ›´æ–°çŠ¶æ€
                          last_state_str = current_state_str
                          last_winner = name
              
              # --- å¦‚æœå…³é”®å¸§å¤ªå¤š(è¶…è¿‡5ä¸ª)ï¼Œä¸ºäº†è¡¨æ ¼ç¾è§‚ï¼Œåªå–å¤´å°¾å’Œä¸­é—´çš„è½¬æŠ˜ç‚¹ ---
              # (ä½†ä½ ç°åœ¨çš„éœ€æ±‚æ˜¯æƒ³çœ‹å…¨è¿‡ç¨‹ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆä¿ç•™ç²¾å)
              # ä¼˜åŒ–ï¼šå¦‚æœè¿ç»­å˜åŒ–æå°ï¼Œå¯ä»¥ä¸æ˜¾ç¤ºã€‚ä½†ç›®å‰é€»è¾‘æ˜¯èƒœç‡å˜1%å°±æ˜¾ç¤ºã€‚
              
              # ç”Ÿæˆ Markdown å­—ç¬¦ä¸²
              md_parts = []
              for kf in key_frames:
                  # æ˜¾ç¤ºæ ¼å¼: 10:00 Trump(55%)
                  # å¦‚æœæ—¶é—´æ˜¯ç©ºçš„ï¼Œå°±ä¸æ˜¾ç¤ºæ—¶é—´
                  t_prefix = f"*{kf['time']}* " if kf['time'] else ""
                  
                  # æ ¼å¼åŒ–æ¦‚ç‡
                  prob_fmt = f"{kf['prob']*100:.0f}%"
                  
                  # æ„é€ æ˜¾ç¤ºæ–‡æœ¬
                  item_str = f"{t_prefix}{kf['name']}({prob_fmt})"
                  
                  if kf['is_flip']:
                      md_parts.append(f"ğŸ”€ `{item_str}`") # åè½¬é«˜äº®
                  else:
                      md_parts.append(f"`{item_str}`")
              
              # ç”¨ç®­å¤´è¿æ¥
              timeline_md = " â†’ ".join(md_parts)
              
              return timeline_md, key_frames

          # === 4. èšåˆæ•°æ® ===
          event_map = {}
          for filename in os.listdir(source_dir):
              if filename.endswith(".json"):
                  try:
                      with open(os.path.join(source_dir, filename), 'r') as f:
                          content = json.load(f)
                          meta = content.get('meta', {})
                          data = content.get('data', {})
                          eid = meta.get('id', data.get('slug', 'unknown'))
                          
                          if eid not in event_map:
                              event_map[eid] = { "count": 0, "history": [], "latest_data": content }
                          
                          event_map[eid]["count"] += 1
                          ts = meta.get('fetch_time_iso', filename)
                          event_map[eid]["history"].append((ts, content))
                          
                          if float(data.get('volume', 0)) > float(event_map[eid]['latest_data'].get('data', {}).get('volume', 0)):
                              event_map[eid]['latest_data'] = content
                  except: pass

          # === 5. ç”Ÿæˆåˆ†æç»“æœ ===
          report_list = []

          for eid, info in event_map.items():
              raw_data = info['latest_data']
              data = raw_data.get('data', {})
              meta = raw_data.get('meta', {})
              
              top = get_top_candidate(data)
              consensus = f"ğŸ‘‘ {top[0]} ({top[1]*100:.1f}%)" if top else "N/A"
              
              # â˜… è°ƒç”¨æ–°çš„æ™ºèƒ½å»é‡å‡½æ•°
              t_str, t_data = generate_smart_timeline(info['history'])

              report_item = {
                  "id": eid,
                  "title": meta.get('title', data.get('title', eid)),
                  "sector": meta.get('sector_tag', 'General'),
                  "heat_count": info['count'],
                  "volume": float(data.get('volume', 0)),
                  "consensus": consensus,
                  "timeline_md": t_str,   # æ™ºèƒ½å»é‡åçš„ MD å­—ç¬¦ä¸²
                  "timeline_data": t_data, # ç»“æ„åŒ–æ•°æ®
                  "url": f"https://polymarket.com/event/{eid}"
              }
              report_list.append(report_item)

          report_list.sort(key=lambda x: (x['heat_count'], x['volume']), reverse=True)

          # === 6. è¾“å‡º MD ===
          md = f"# ğŸ“Š 24H æ™ºèƒ½å¤ç›˜ ({latest_date})\n\n"
          md += f"**ç”Ÿæˆæ—¶é—´**: 23:55 | **å»é‡é€»è¾‘**: ä»…è®°å½•èƒœç‡(1%)å˜åŒ–çš„å…³é”®æ—¶åˆ»\n\n"
          md += "| çƒ­åº¦ | æ¿å— | äº‹ä»¶æ ‡é¢˜ | ğŸ”¥ æœ€ç»ˆèµ¢å®¶ | ğŸŒŠ èµ„é‡‘åšå¼ˆå…³é”®å¸§ (Time/Name/Prob) |\n"
          md += "| :--- | :--- | :--- | :--- | :--- |\n"

          for item in report_list:
              icon = "ğŸ”¥ğŸ”¥ğŸ”¥" if item['heat_count']>=20 else "ğŸ”¥" if item['heat_count']>=10 else "â­ï¸"
              # æˆªæ–­å¤ªé•¿çš„æ ‡é¢˜
              title = item['title'][:40] + "..." if len(item['title']) > 40 else item['title']
              
              md += f"| {icon} | {item['sector']} | [{title}]({item['url']}) | {item['consensus']} | {item['timeline_md']} |\n"

          with open(f"{report_dir}/DAILY_HEATMAP_{latest_date}.md", "w") as f:
              f.write(md)

          # === 7. è¾“å‡º JSON ===
          with open(f"{report_dir}/DAILY_SUMMARY_{latest_date}.json", "w") as f:
              json.dump(report_list, f, indent=2)

          print(f"âœ… V11 å®Œæˆï¼")
          EOF

          python analyzer.py

      - name: Commit results
        run: |
          git config --global user.name "Report Bot"
          git config --global user.email "bot@github.com"
          git add reports/
          git commit -m "ğŸ“Š V11 Smart Timeline Report" || exit 0
          git push
